rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      // Allow read if user owns the business
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Allow create if user is authenticated and sets their userId
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.name is string;
      
      // Allow update if user owns the business
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId;
      
      // Allow delete if user owns the business
      allow delete: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid;
    }
    
    // Campaigns collection
    match /campaigns/{campaignId} {
      // Allow read if user owns the campaign
      allow read: if isOwner(resource.data.userId);
      
      // Allow create if user is authenticated and sets their userId
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.name is string;
      
      // Allow update if user owns the campaign
      allow update: if isOwner(resource.data.userId)
                    && request.resource.data.userId == resource.data.userId;
      
      // Allow delete if user owns the campaign
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Posts collection
    match /posts/{postId} {
      // Helper to check if user owns the business that the post belongs to
      function ownsPostBusiness() {
        return isAuthenticated() &&
               resource.data.businessId != null &&
               exists(/databases/$(database)/documents/businesses/$(resource.data.businessId)) &&
               get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.userId == request.auth.uid;
      }
      
      // Allow read if user owns the post (either directly via userId or via business ownership)
      allow read: if isAuthenticated() && 
                    (resource.data.userId == request.auth.uid || ownsPostBusiness());
      
      // Allow read of scheduled posts without auth (for cron job to find posts to publish)
      // Note: This is needed for the cron job but less secure. Consider using Firebase Admin SDK.
      allow read: if resource.data.status == "scheduled";
      
      // Allow create if user is authenticated and sets their userId
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.content is string;
      
      // Allow update if user owns the post
      allow update: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.userId == resource.data.userId;
      
      // Allow cron job to update scheduled posts to published/failed (without auth)
      // Security: Only allows status change from "scheduled" to "published" or "failed"
      // and prevents changing userId or other sensitive fields
      allow update: if resource.data.status == "scheduled" &&
                    request.resource.data.userId == resource.data.userId &&
                    request.resource.data.content == resource.data.content &&
                    request.resource.data.businessId == resource.data.businessId &&
                    request.resource.data.platform == resource.data.platform &&
                    (request.resource.data.status == "published" || 
                     request.resource.data.status == "failed");
      
      // Allow delete if user owns the post
      allow delete: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
    }
    
    // Facebook connections collection (stored by businessId)
    match /facebook_connections/{businessId} {
      // Helper to check if user owns the business
      function ownsBusiness() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/businesses/$(businessId)) &&
               get(/databases/$(database)/documents/businesses/$(businessId)).data.userId == request.auth.uid;
      }
      
      // Allow read if user owns the business
      allow read: if ownsBusiness();
      
      // Allow read without auth if business exists (for cron job when publishing scheduled posts)
      // Note: Less secure but needed for cron. Consider using Firebase Admin SDK.
      allow read: if exists(/databases/$(database)/documents/businesses/$(businessId));
      
      // Allow create if user owns the business and sets correct fields
      allow create: if ownsBusiness() &&
                    request.resource.data.businessId == businessId &&
                    request.resource.data.userId == request.auth.uid;
      
      // Allow update/delete if user owns the business
      allow update, delete: if ownsBusiness();
    }
    
    // Post analytics collection
    match /post_analytics/{analyticsId} {
      // Helper to check if user owns the business (for existing documents)
      function ownsAnalyticsBusiness() {
        return isAuthenticated() &&
               resource.data.businessId != null &&
               exists(/databases/$(database)/documents/businesses/$(resource.data.businessId)) &&
               get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.userId == request.auth.uid;
      }
      
      // Helper to check if user owns the business (for new documents)
      function ownsAnalyticsBusinessForCreate() {
        return isAuthenticated() &&
               request.resource.data.businessId != null &&
               exists(/databases/$(database)/documents/businesses/$(request.resource.data.businessId)) &&
               get(/databases/$(database)/documents/businesses/$(request.resource.data.businessId)).data.userId == request.auth.uid;
      }
      
      // Allow read if user owns the business (handles both single reads and queries)
      allow read: if isAuthenticated() &&
                  resource.data.businessId != null &&
                  exists(/databases/$(database)/documents/businesses/$(resource.data.businessId)) &&
                  get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.userId == request.auth.uid;
      
      // Allow create if user owns the business
      allow create: if ownsAnalyticsBusinessForCreate();
      
      // Allow update if user owns the business
      allow update: if ownsAnalyticsBusiness() &&
                    request.resource.data.businessId == resource.data.businessId;
      
      // Allow delete if user owns the business
      allow delete: if ownsAnalyticsBusiness();
    }
  }
}

